# 3Dカーゲーム 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
3Dカーゲーム（Babylon.js + Physics 対応）

### 1.2 プロジェクト説明
Web ブラウザ上で動作する 3D カーゲーム。Babylon.js による 3D 描画と Cannon.js 物理演算を使用し、タイムアタック、ランキング、ゴースト、環境設定、サウンド、車両カスタマイズ、ミニマップなどを提供する。

### 1.3 開発環境
- **プラットフォーム**: Web（HTML5）
- **使用ライブラリ**:
  - Babylon.js（3D レンダリング/シーン管理）
  - Cannon.js（物理演算）
- **対応ブラウザ**: Chrome、Firefox、Safari、Edge 等のモダンブラウザ
- **ファイル形式**: 単一 HTML ファイル（1ファイル完結型）

---

## 2. 機能要件

### 2.1 ゲーム基本機能

#### 2.1.1 車両制御
- **前進**: W / ↑
- **後退**: S / ↓
- **左旋回**: A / ←
- **右旋回**: D / →
- **ブレーキ**: Space
- **カメラ**: 追従カメラ（FollowCamera）

#### 2.1.2 物理演算
- 重力、加速度、摩擦のシミュレーション
- 壁・障害物との衝突判定
- 車体の接地・ジャンプ挙動

#### 2.1.3 コースシステム
- **コース選択**: UI から切り替え
- **デフォルトコース**: コース1
- **ビットマップコース**: 画像アップロードで生成
  - 白=道路 / 黒=壁 / 青=スタート / 緑=ゴール / 赤=障害物

#### 2.1.4 タイムアタック
- カウントダウン後に計測開始
- ゴール判定時にタイム表示
- ベストタイム/Top5 更新

#### 2.1.5 リセット機能
- リセットボタンでスタート地点に復帰
- カウントダウンを再実行

### 2.2 記録・リプレイ

#### 2.2.1 ベストタイム
- コース別にベストタイムを保存

#### 2.2.2 Top5 ランキング
- コース別に上位 5 件を保存
- 長押しで Top5 を削除

#### 2.2.3 ゴースト
- ベスト更新時に走行データを保存
- 次回以降の走行でゴースト表示
- `G` キーで表示切り替え

#### 2.2.4 デルタ表示
- 走行中にゴーストとの差分時間（Δ）を表示

### 2.3 ユーザーインターフェース（UI）

#### 2.3.1 HUD
- **表示内容**: スピードメーター、経過時間、Best、Ghost、Δ
- **配置**: 画面左上

#### 2.3.2 コースセレクター
- **位置**: 画面上部中央
- **機能**: コース切り替えと画像アップロード

#### 2.3.3 ミニマップ
- **位置**: 画面右上
- **表示内容**: コース概形、スタート/ゴール、障害物、車位置

#### 2.3.4 ランキングパネル
- **位置**: 画面右下
- **内容**: Top5 表示、Best/Ghost クリア操作

#### 2.3.5 サウンドコントロール
- **位置**: 画面左下
- **内容**: ON/OFF ボタン、音量スライダー

#### 2.3.6 ポーズメニュー
- **起動**: `P` キー
- **内容**: 再開、環境設定、カスタマイズ、チュートリアル

#### 2.3.7 チュートリアル
- **表示**: メニューから起動
- **内容**: 操作方法、ゴースト/ランキングの説明

#### 2.3.8 カスタマイズ
- **内容**: ボディ/ボンネット/トランク/ウィンドウの色変更
- **保存**: LocalStorage で保持

#### 2.3.9 環境設定
- **時間帯**: 朝/昼/夕/夜
- **天候**: 晴れ/曇り/雨
- **影響**: スカイボックス、ライト、フォグ、夜間ヘッドライト
- **保存**: LocalStorage で保持

---

## 3. 非機能要件

### 3.1 パフォーマンス
- **フレームレート**: 60 FPS を目標
- **入力応答**: キー入力から車両動作まで 50ms 以内

### 3.2 互換性
- **OS**: Windows、macOS、Linux
- **ブラウザ**: 最新版の Chrome、Firefox、Safari、Edge

### 3.3 視認性
- **配色**: ダークトーン UI
- **フォント**: Noto Sans JP / Rajdhani
- **UI レスポンシブ**: 画面幅 720px 以下で縮小

### 3.4 外部依存
- Babylon.js / Cannon.js を CDN 経由で読み込み
- Google Fonts を CDN 経由で読み込み

---

## 4. データ要件

### 4.1 保存データ（LocalStorage）
- ベストタイム（コース別）
- Top5 ランキング（コース別）
- ゴーストデータ（コース別）
- ゴースト ON/OFF 状態
- 環境設定（時間帯/天候）
- 車両カラーカスタマイズ

### 4.2 外部ファイル
- ビットマップコース用画像ファイル（PNG/BMP 推奨）

---

## 5. 制約条件

### 5.1 技術的制約
- HTML5 標準機能のみ利用（プラグインなし）
- CDN 依存のため、オフライン環境では一部機能に制限
- 保存データは LocalStorage のみを使用（サーバ保存なし）

### 5.2 デザイン制約
- UI はゲームプレイの邪魔にならない最小限の占有を基本とする

---

## 6. ユースケース

### 6.1 標準的なゲームプレイフロー
1. ユーザーが `index.html` を開く
2. 画面 UI が表示され、カウントダウン開始
3. 車両操作でゴール地点を目指す
4. ゴール到達時にタイムが表示され、Best/Top5/ゴーストが更新

### 6.2 コース切り替え
1. コースセレクターでコースを選択
2. 変更後にカウントダウンが再実行

### 6.3 ビットマップコースの利用
1. 画像をアップロード
2. 画像をコースに変換
3. ビットマップコースで走行

### 6.4 環境設定の変更
1. `P` キーでメニューを開く
2. 環境設定を選択
3. 時間帯/天候を切り替えて反映

### 6.5 カスタマイズの変更
1. `P` キーでメニューを開く
2. カスタマイズを選択
3. 色を変更し、設定を保存

---

## 7. テスト要件

### 7.1 機能テスト
- [ ] 車両操作（W/A/S/D・矢印）が動作すること
- [ ] ブレーキ（Space）が動作すること
- [ ] コース切り替えが動作すること
- [ ] ビットマップコース生成が動作すること
- [ ] ゴール判定・タイム計測が動作すること
- [ ] Best/Top5/ゴースト保存が動作すること
- [ ] ゴースト ON/OFF が動作すること
- [ ] ミニマップ更新が動作すること
- [ ] 環境設定/カスタマイズが反映・保存されること
- [ ] サウンドの ON/OFF/音量調整が動作すること

### 7.2 互換性テスト
- [ ] Chrome での動作確認
- [ ] Firefox での動作確認
- [ ] Safari での動作確認
- [ ] Edge での動作確認

### 7.3 パフォーマンステスト
- [ ] 60 FPS の安定稼働確認
- [ ] CPU/GPU 使用率の確認

---

## 8. 今後の拡張案（Out of Scope）

- マルチプレイヤー
- オンラインランキング
- コースエディタ（Web UI）
- モバイル向けの専用操作 UI
- 追加コース/車種の拡張

---

## 9. 成功基準

- [ ] ゲームが正常にロードされる
- [ ] 主要ブラウザで動作する
- [ ] タイム計測とランキングが正常に更新される
- [ ] ゴーストが正常に再生される
- [ ] 環境設定とカスタマイズが保存/復元される

---

## 10. 用語集

| 用語 | 説明 |
|------|------|
| HUD | Head-Up Display（画面上に情報を表示するUI） |
| Babylon.js | Web 3D グラフィックスライブラリ |
| Cannon.js | JavaScript 物理演算エンジン |
| LocalStorage | ブラウザの永続ストレージ |
| ゴースト | ベスト走行を再生するリプレイデータ |

---

**作成日**: 2026年1月13日
**更新日**: 2026年1月22日
**バージョン**: 2.0
**ステータス**: 実装内容に同期済み
